#!/usr/bin/env ruby

require 'fileutils'
include FileUtils

begin
  require 'highline/import'
rescue LoadError
  STDERR.puts 'Installing highline.'
  system 'gem', 'install', 'highline'
  exec $0, *ARGV
end

if ARGV.length == 0
  exec ENV['BROWSER'], 'https://aur4.archlinux.org/packages'
end

package = ARGV[0]
if File.directory? package
  puts "Deleting old version of #{package}."
  rm_rf package
end
puts 'Fetching updated version.'
system 'get', '-z', "https://aur4.archlinux.org/cgit/aur.git/snapshot/#{package}.tar.gz"

Dir.chdir package do
  puts 'Making package.'
  system 'makepkg'

  install = ask("Install #{package}? [y] ") { |s| s.in = ['', 'y', 'n']}
  if install != 'n'
    system 'sudo', 'pacman', '-U', '--noconfirm', *Dir['*.pkg.tar.xz']
  end
end

puts 'Stashing packages in pkg/.'
mv Dir["#{package}/*.pkg.tar.xz"], 'pkg/'
